<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>ESP32 Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/wifi/css/materialize.min.css" rel="stylesheet">
  <link href="/wifi/css/material-icons.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
    }

    .info-card {
      margin-bottom: 2rem;
    }

    .btn-danger {
      background-color: #e53935 !important;
    }
  </style>
</head>

<body>
  <h4>⚙️ ESP32 Admin</h4>

  <div class="card info-card">
    <div class="card-content">
      <span class="card-title">Netzwerkstatus</span>
      <p><strong>SSID:</strong> <span id="ssid">...</span></p>
      <p><strong>IP-Adresse:</strong> <span id="ip">...</span></p>
      <p><strong>mDNS:</strong> <span id="mdns">...</span></p>
    </div>
  </div>

  <div class="card info-card blue lighten-5">
    <div class="card-content">
      <span class="card-title blue-text">OTA</span>
      <p><strong>Status:</strong> <span id="otaEnabled">...</span></p>
      <p><strong>Host:</strong> <span id="otaHost">...</span></p>
      <p><strong>Port:</strong> <span id="otaPort">...</span></p>
      <p><strong>Fenster:</strong> <span id="otaWindow">...</span></p>
      <p><strong>Restzeit:</strong> <span id="otaRemaining">...</span></p>
      <p><strong>Passwort:</strong> <span id="otaPassword">••••••••</span></p>
    </div>
    <div class="card-action">
      <a class="btn blue" id="otaExtendBtn">
        <i class="material-icons left">timer</i> +10 Minuten
      </a>
      <a class="btn orange" id="otaRegenBtn">
        <i class="material-icons left">vpn_key</i> Passwort neu generieren
      </a>
    </div>
  </div>


  <div class="card red lighten-4">
    <div class="card-content">
      <span class="card-title red-text">Zurücksetzen</span>
      <p>Hier kannst du die gespeicherten WLAN-Zugangsdaten löschen. Danach startet der ESP32 im AP-Modus neu.</p>
    </div>
    <div class="card-action">
      <a class="btn btn-danger" id="resetBtn"><i class="material-icons left">delete</i> Zurücksetzen</a>
    </div>
  </div>

  <script src="wifi/js/materialize.min.js"></script>
  <script>
    fetch('/status')
      .then(r => r.json())
      .then(data => {
        document.getElementById('ssid').textContent = data.ssid || '-';
        document.getElementById('ip').textContent = data.ip || '-';
        document.getElementById('mdns').textContent = data.mdns || '-';
      })
      .catch(err => console.error("Fehler beim Laden des Status:", err));

    function loadOtaStatus() {
      fetch('/ota/status')
        .then(r => r.json())
        .then(data => {
          document.getElementById('otaEnabled').textContent = (data.enabled ? "aktiv" : "aus");
          document.getElementById('otaHost').textContent = data.host || '-';
          document.getElementById('otaPort').textContent = (data.port != null ? data.port : '-');
          document.getElementById('otaWindow').textContent = (data.windowSeconds != null ? (data.windowSeconds + " s") : '-');
          document.getElementById('otaRemaining').textContent = (data.remainingSeconds != null ? (data.remainingSeconds + " s") : '-');
          document.getElementById('otaPassword').textContent = (data.password && data.password.length ? data.password : "••••••••");
        })
        .catch(err => console.error("Fehler beim Laden des OTA-Status:", err));
    }

    loadOtaStatus();
    setInterval(loadOtaStatus, 5000);

    document.getElementById('otaExtendBtn').onclick = () => {
      fetch('/ota/extend', { method: 'POST' })
        .then(r => {
          if (!r.ok) throw new Error("extend failed");
          M.toast({ html: "OTA-Window is refreshed", classes: "blue" });
          loadOtaStatus();
        })
        .catch(err => {
          M.toast({ html: "Error: OTA-Window is not refreshed", classes: "red" });
          console.error(err);
        });
    };

    document.getElementById('otaRegenBtn').onclick = () => {
      if (confirm("Generate new OTA-password?")) {
        fetch('/ota/regenerate-password', { method: 'POST' })
          .then(r => {
            if (!r.ok) throw new Error("regen failed");
            M.toast({ html: "Generated new password", classes: "orange" });
            loadOtaStatus();
          })
          .catch(err => {
            M.toast({ html: "Error: Cannot generate new password", classes: "red" });
            console.error(err);
          });
      }
    };

    document.getElementById('resetBtn').onclick = () => {
      if (confirm("Wirklich zurücksetzen und neu starten?")) {
        fetch('/reset', { method: 'POST' })
          .then(() => {
            M.toast({ html: "Zurückgesetzt. ESP32 startet neu...", classes: "red" });
          })
          .catch(err => {
            M.toast({ html: "Fehler beim Zurücksetzen", classes: "red" });
            console.error(err);
          });
      }
    };
  </script>
</body>

</html>