<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>WiFi Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/css/materialize.min.css" rel="stylesheet">
  <link href="/css/material-icons.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
    }

    .wifi-item {
      cursor: pointer;
    }

    .wifi-strength {
      float: right;
    }

    #loader {
      display: none;
      text-align: center;
      margin-top: 2rem;
    }

    .status-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      display: none;
    }

    .status-message.success {
      background-color: #c8e6c9;
      color: #2e7d32;
      display: block;
    }

    .status-message.error {
      background-color: #ffcdd2;
      color: #c62828;
      display: block;
    }

    .current-ssid {
      background-color: #e3f2fd;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <h4>ðŸ“¶ WLAN Konfiguration</h4>

  <!-- Currently connected WiFi -->
  <div class="current-ssid" id="currentSsid" style="display: none;">
    <p><strong>Aktuell verbunden:</strong> <span id="connectedSsid">-</span></p>
  </div>

  <!-- Status message -->
  <div class="status-message" id="statusMessage"></div>

  <!-- Available networks -->
  <h5>VerfÃ¼gbare Netzwerke</h5>

  <div id="loader">
    <div class="preloader-wrapper active">
      <div class="spinner-layer spinner-blue-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div>
        <div class="gap-patch">
          <div class="circle"></div>
        </div>
        <div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>
    <p>Netzwerke werden aktualisiert...</p>
  </div>

  <ul class="collection" id="wifiList"></ul>

  <!-- Password modal -->
  <div id="passModal" class="modal">
    <div class="modal-content">
      <h5>Passwort eingeben</h5>
      <p>Netzwerk: <strong id="modalSsid">-</strong></p>
      <div class="input-field">
        <input id="wifiPass" type="password" autocomplete="off">
        <label for="wifiPass">Passwort</label>
      </div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Abbrechen</a>
      <a href="#!" id="submitWifi" class="waves-effect waves-green btn">Verbinden</a>
    </div>
  </div>

  <script src="/js/materialize.min.js"></script>
  <script>
    // ========== WebSocket Communication ==========
    let ws = null;
    let modelData = {
      wifi: {
        ssid: "",
        pass: "",
        available_networks: []
      }
    };

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log("[WS] Connected");
      };
      
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log("[WS] Received:", msg);
          
          if (msg.topic === 'wifi') {
            updateWifiModel(msg.data);
          }
        } catch (e) {
          console.error("[WS] Parse error:", e);
        }
      };
      
      ws.onerror = (error) => {
        console.error("[WS] Error:", error);
        showError("WebSocket-Fehler: Verbindung zum GerÃ¤t verloren");
      };
      
      ws.onclose = () => {
        console.log("[WS] Disconnected, reconnecting in 3 seconds...");
        setTimeout(connectWebSocket, 3000);
      };
    }

    function updateWifiModel(data) {
      console.log("[Model] WiFi update:", data);
      
      if (data.ssid !== undefined) {
        modelData.wifi.ssid = data.ssid.value || "";
      }
      
      if (data.pass !== undefined) {
        // Don't store password locally for security
        modelData.wifi.pass = "";
      }
      
      if (data.available_networks !== undefined) {
        const networks = data.available_networks;
        if (networks.items && Array.isArray(networks.items)) {
          modelData.wifi.available_networks = networks.items;
          renderWifiList();
        }
      }
      
      updateCurrentSsid();
    }

    function sendWifiUpdate(ssid, password) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showError("Nicht mit WebSocket verbunden");
        return;
      }

      const update = {
        wifi: {
          ssid: ssid,
          pass: password
        }
      };

      console.log("[WS] Sending WiFi update:", update);
      ws.send(JSON.stringify(update));
      
      showSuccess("Verbindungsversuch gestartet...");
    }

    // ========== UI Functions ==========
    function renderWifiList() {
      const list = document.getElementById('wifiList');
      list.innerHTML = '';
      
      if (!modelData.wifi.available_networks || modelData.wifi.available_networks.length === 0) {
        list.innerHTML = '<li class="collection-item">Keine Netzwerke gefunden</li>';
        return;
      }

      modelData.wifi.available_networks.forEach(ssid => {
        const li = document.createElement('li');
        li.className = 'collection-item wifi-item';
        li.innerHTML = `
          <span><strong>${ssid}</strong></span>
          <i class="material-icons wifi-strength">wifi</i>
        `;
        li.onclick = () => {
          document.getElementById('modalSsid').textContent = ssid;
          document.getElementById('wifiPass').value = '';
          M.updateTextFields();
          passModal.open();
        };
        list.appendChild(li);
      });

      document.getElementById('loader').style.display = 'none';
    }

    function updateCurrentSsid() {
      const ssidDisplay = document.getElementById('currentSsid');
      const connectedSsidSpan = document.getElementById('connectedSsid');
      
      if (modelData.wifi.ssid && modelData.wifi.ssid.trim()) {
        connectedSsidSpan.textContent = modelData.wifi.ssid;
        ssidDisplay.style.display = 'block';
      } else {
        ssidDisplay.style.display = 'none';
      }
    }

    function showSuccess(msg) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = 'status-message success';
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function showError(msg) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = 'status-message error';
    }

    // ========== Init ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize modal
      const passModal = M.Modal.init(document.getElementById('passModal'));
      
      // Connect WebSocket
      connectWebSocket();
      
      // Submit button handler
      document.getElementById('submitWifi').onclick = (e) => {
        e.preventDefault();
        
        const ssid = document.getElementById('modalSsid').textContent;
        const pass = document.getElementById('wifiPass').value;
        
        if (!ssid || !pass) {
          showError("Bitte SSID und Passwort eingeben");
          return;
        }
        
        sendWifiUpdate(ssid, pass);
        passModal.close();
      };
      
      // Show loader initially
      document.getElementById('loader').style.display = 'block';
    });
  </script>
</body>

</html>
