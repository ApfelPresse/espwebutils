<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>WiFi Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/css/materialize.min.css" rel="stylesheet">
  <link href="/css/material-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f9fc;
      --card-radius: 14px;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15, 23, 42, 0.08);
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .page-wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 1.25rem;
    }

    h4 { margin: 0 0 0.75rem 0; font-weight: 700; letter-spacing: -0.01em; }

    .card {
      border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin: 0;
    }

    .wifi-item {
      cursor: pointer;
    }

    .wifi-strength {
      float: right;
    }

    #loader {
      display: none;
      text-align: center;
      margin-top: 2rem;
    }

    .status-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      display: none;
    }

    .status-message.success {
      background-color: #c8e6c9;
      color: #2e7d32;
      display: block;
    }

    .status-message.info {
      background-color: #e3f2fd;
      color: #1565c0;
      display: block;
    }

    .status-message.error {
      background-color: #ffcdd2;
      color: #c62828;
      display: block;
    }

    .current-ssid {
      background-color: #e3f2fd;
      padding: 0.9rem 1rem;
      border-radius: 10px;
      border: 1px solid rgba(30, 136, 229, 0.15);
      margin-bottom: 1rem;
    }

    #debugPanel {
      margin-top: 2rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      max-height: 60vh;
    }

    #debugPanel h6 {
      background-color: #263238;
      color: white;
      padding: 0.75rem 1rem;
      margin: 0;
      border-radius: 4px 4px 0 0;
      flex-shrink: 0;
      font-size: 0.95rem;
    }

    #debugLog {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0.75rem;
      font-family: 'Courier New', monospace;
      font-size: 0.7rem;
      background-color: #263238;
      color: #aed581;
      margin: 0;
      word-break: break-all;
    }

    .debug-entry {
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }

    .debug-timestamp {
      color: #64b5f6;
      margin-right: 0.3rem;
      display: inline-block;
      min-width: 70px;
    }

    .debug-direction {
      color: #ffb74d;
      font-weight: bold;
      margin-right: 0.3rem;
      display: inline-block;
      min-width: 40px;
    }

    @media (max-width: 600px) {
      .page-wrap { padding: 0.9rem; }
      h4 { font-size: 1.6rem; }
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <h4>WLAN Konfiguration</h4>

    <!-- Currently connected WiFi -->
    <div class="current-ssid" id="currentSsid" style="display: none;">
      <p style="margin:0;"><strong>Aktuell verbunden:</strong> <span id="connectedSsid">-</span></p>
    </div>

    <!-- Status message -->
    <div class="status-message" id="statusMessage"></div>

    <!-- Available networks -->
    <div class="card" style="margin-top: 1rem;">
      <div class="card-content">
        <div class="section-title">
          <h5 style="margin:0; font-weight:700;">Verfügbare Netzwerke</h5>
          <a class="btn-floating btn-small waves-effect waves-light blue" onclick="scanNetworks()" title="Netzwerke scannen">
            <i class="material-icons">refresh</i>
          </a>
        </div>

    <div id="loader">
    <div class="preloader-wrapper active">
      <div class="spinner-layer spinner-blue-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div>
        <div class="gap-patch">
          <div class="circle"></div>
        </div>
        <div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>
          <p style="margin:0.75rem 0 0 0; color: var(--muted);">Netzwerke werden aktualisiert...</p>
        </div>

        <ul class="collection" id="wifiList" style="margin-top: 0.75rem;"></ul>
      </div>
    </div>

  <!-- Debug Panel (shown only in TRACE mode) -->
    <div id="debugPanel" style="display: none;">
      <h6>
        WebSocket Debug Log
        <a class="btn-flat btn-small waves-effect white-text right" onclick="clearDebugLog()" style="padding: 0 0.5rem;">Clear</a>
      </h6>
      <div id="debugLog"></div>
    </div>

  <!-- Password modal -->
  <div id="passModal" class="modal">
    <div class="modal-content">
      <h5>Passwort eingeben</h5>
      <p>Netzwerk: <strong id="modalSsid">-</strong></p>
      <div class="input-field">
        <input id="wifiPass" type="password" autocomplete="off">
        <label for="wifiPass">Passwort</label>
      </div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Abbrechen</a>
      <a href="#!" id="submitWifi" class="waves-effect waves-green btn">Verbinden</a>
    </div>
  </div>

  <script src="/js/materialize.min.js"></script>
  <script src="/js/ws_demo_data.js"></script>
  <script src="/js/ws_mock.js"></script>
  <script>
    // ========== Debug Mode ==========
    // Matches model.html behavior: enable with ?debug=1
    let DEBUG_MODE = false;

    function initDebugMode() {
      try {
        const qs = new URLSearchParams(window.location.search);
        DEBUG_MODE = qs.get('debug') === '1';
      } catch (_) {
        DEBUG_MODE = false;
      }
      const panel = document.getElementById('debugPanel');
      if (panel) panel.style.display = DEBUG_MODE ? 'block' : 'none';
      if (DEBUG_MODE) addDebugLog('ℹ INFO', 'Debug mode enabled (?debug=1)');
    }
    
    function addDebugLog(direction, data) {
      if (!DEBUG_MODE) return;
      
      const debugLog = document.getElementById('debugLog');
      const entry = document.createElement('div');
      entry.className = 'debug-entry';
      
      const timestamp = new Date().toLocaleTimeString('de-DE', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
      const jsonStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      
      entry.innerHTML = `<span class="debug-timestamp">${timestamp}</span><span class="debug-direction">${direction}</span>${jsonStr}`;
      debugLog.appendChild(entry);
      
      // Auto-scroll to bottom
      debugLog.scrollTop = debugLog.scrollHeight;
      
      // Limit to last 100 entries
      while (debugLog.children.length > 100) {
        debugLog.removeChild(debugLog.firstChild);
      }
    }
    
    function clearDebugLog() {
      document.getElementById('debugLog').innerHTML = '';
    }
    
    // ========== WebSocket Communication ==========
    let ws = null;
    let passModal = null; // Global variable for modal
    let pendingScan = false;
    let modelData = {
      wifi: {
        ssid: "",
        pass: "",
        available_networks: []
      }
    };

    function clearStatus() {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = '';
      statusDiv.className = 'status-message';
      statusDiv.style.display = 'none';
    }

    function showInfo(msg, autoHideMs = 2500) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = 'status-message info';
      statusDiv.style.display = 'block';
      if (autoHideMs) setTimeout(clearStatus, autoHideMs);
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      console.log('[WS] Connecting to:', wsUrl);
      addDebugLog('ℹ INFO', `Connecting to ${wsUrl}`);
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log("[WS] Connected");
        addDebugLog('✓ SUCCESS', 'WebSocket connected');

        // Clear any stale "not connected" status from initial page load.
        clearStatus();

        if (pendingScan) {
          pendingScan = false;
          scanNetworks();
        }
      };
      
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log("[WS] Received:", msg);
          addDebugLog('⬇ RX', msg);

          // Any valid message means the connection works.
          clearStatus();
          
          if (msg.topic === 'wifi') {
            updateWifiModel(msg.data);
          } else {
            console.log(`[WS] Ignoring topic: ${msg.topic}`);
          }
        } catch (e) {
          console.error("[WS] Parse error:", e);
          addDebugLog('⚠ ERROR', `Parse error: ${e.message}`);
        }
      };
      
      ws.onerror = (error) => {
        console.error("[WS] Error:", error);
        addDebugLog('⚠ ERROR', `WebSocket error: ${error.type}`);
        showError("WebSocket-Fehler: Verbindung zum Gerät verloren", 5000);
      };
      
      ws.onclose = () => {
        console.log("[WS] Disconnected, reconnecting in 3 seconds...");
        addDebugLog('ℹ INFO', 'WebSocket closed, reconnecting in 3s...');
        showInfo('WebSocket getrennt — verbinde erneut…', 1500);
        setTimeout(connectWebSocket, 3000);
      };
    }

    function updateWifiModel(data) {
      console.log("[Model] WiFi update:", data);
      addDebugLog('ℹ INFO', 'Model update received');
      
      if (data.ssid !== undefined) {
        modelData.wifi.ssid = data.ssid.value || "";
        console.log('[Model] SSID updated to:', modelData.wifi.ssid);
      }
      
      if (data.pass !== undefined) {
        // Don't store password locally for security
        modelData.wifi.pass = "";
        console.log('[Model] Password field present (not stored locally)');
      }
      
      if (data.available_networks !== undefined) {
        const networks = data.available_networks;
        console.log('[Model] Available networks:', networks);
        if (networks.items && Array.isArray(networks.items)) {
          modelData.wifi.available_networks = networks.items;
          console.log(`[Model] Updated network list: ${networks.items.length} networks`);
          addDebugLog('ℹ INFO', `Network list updated: ${networks.items.length} networks`);
          renderWifiList();
        }
      }
      
      updateCurrentSsid();
    }

    function sendWifiUpdate(ssid, password) {
      console.log('[WS] sendWifiUpdate called with:', { ssid, password });
      addDebugLog('ℹ INFO', `Attempting to send WiFi update: SSID=${ssid}`);
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('[WS] WebSocket not connected, readyState:', ws ? ws.readyState : 'null');
        showError("Nicht mit WebSocket verbunden");
        addDebugLog('⚠ ERROR', 'WebSocket not connected');
        return;
      }

      const update = {
        topic: "wifi",
        data: {
          ssid: ssid,
          pass: password
        }
      };
      
      const updateStr = JSON.stringify(update);
      console.log("[WS] Sending WiFi update:", update);
      addDebugLog('⬆ TX', update);
      ws.send(updateStr);
      
      showSuccess("Verbindungsversuch gestartet...");
    }

    function scanNetworks() {
      console.log('[Scan] scanNetworks called');
      addDebugLog('ℹ INFO', 'Starting network scan...');
      document.getElementById('loader').style.display = 'block';

      // Request scan via WebSocket (no /scan endpoint)
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        // During initial load the socket might not be open yet.
        pendingScan = true;
        addDebugLog('ℹ INFO', 'WebSocket not open yet - deferring scan until connected');
        showInfo('Verbinde… starte Scan sobald WebSocket bereit ist', 2000);
        return;
      }

      const msg = { action: 'button_trigger', topic: 'wifi', button: 'scan_networks' };
      addDebugLog('⬆ TX', msg);
      ws.send(JSON.stringify(msg));
    }

    // ========== UI Functions ==========
    function renderWifiList() {
      const list = document.getElementById('wifiList');
      list.innerHTML = '';
      
      if (!modelData.wifi.available_networks || modelData.wifi.available_networks.length === 0) {
        list.innerHTML = '<li class="collection-item">Keine Netzwerke gefunden</li>';
        return;
      }

      modelData.wifi.available_networks.forEach(ssid => {
        const li = document.createElement('li');
        li.className = 'collection-item wifi-item';
        li.innerHTML = `
          <span><strong>${ssid}</strong></span>
          <i class="material-icons wifi-strength">wifi</i>
        `;
        li.onclick = () => {
          console.log('[UI] Opening modal for SSID:', ssid);
          document.getElementById('modalSsid').textContent = ssid;
          document.getElementById('wifiPass').value = '';
          M.updateTextFields();
          if (passModal) {
            passModal.open();
          } else {
            console.error('[UI] passModal not initialized');
          }
        };
        list.appendChild(li);
      });

      document.getElementById('loader').style.display = 'none';
    }

    function updateCurrentSsid() {
      const ssidDisplay = document.getElementById('currentSsid');
      const connectedSsidSpan = document.getElementById('connectedSsid');
      
      if (modelData.wifi.ssid && modelData.wifi.ssid.trim()) {
        connectedSsidSpan.textContent = modelData.wifi.ssid;
        ssidDisplay.style.display = 'block';
      } else {
        ssidDisplay.style.display = 'none';
      }
    }

    function showSuccess(msg) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = 'status-message success';
      statusDiv.style.display = 'block';
      setTimeout(clearStatus, 5000);
    }

    function showError(msg, autoHideMs) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = 'status-message error';
      statusDiv.style.display = 'block';
      if (autoHideMs) setTimeout(clearStatus, autoHideMs);
    }

    // ========== Init ==========
    document.addEventListener('DOMContentLoaded', () => {
      initDebugMode();

      // Initialize modal (global variable)
      passModal = M.Modal.init(document.getElementById('passModal'));
      console.log('[Init] Modal initialized:', passModal !== null);
      
      // Connect WebSocket
      connectWebSocket();
      
      // Submit button handler
      document.getElementById('submitWifi').onclick = (e) => {
        e.preventDefault();
        
        const ssid = document.getElementById('modalSsid').textContent;
        const pass = document.getElementById('wifiPass').value;
        
        console.log('[Submit] Form data:', { ssid, pass });
        
        if (!ssid || !pass) {
          showError("Bitte SSID und Passwort eingeben");
          return;
        }
        
        sendWifiUpdate(ssid, pass);
        passModal.close();
      };
      
      // Trigger initial scan
      console.log('[Init] Starting initial network scan');
      scanNetworks();
    });
  </script>

  </div>
</body>

</html>
