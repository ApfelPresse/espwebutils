<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>ESP32 Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/css/materialize.min.css" rel="stylesheet">
  <link href="/css/material-icons.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
    }

    .info-card {
      margin-bottom: 2rem;
    }

    .btn-danger {
      background-color: #e53935 !important;
    }
  </style>
</head>

<body>
  <h4>⚙️ ESP32 Admin</h4>
  <div id="loginBox" style="margin-bottom:1rem; display:none;">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Login</span>
        <div class="row">
          <div class="input-field col s12">
            <input id="adminPw" type="password">
            <label for="adminPw">Admin Passwort</label>
          </div>
        </div>
      </div>
      <div class="card-action">
        <a class="btn" id="loginBtn">Login</a>
      </div>
    </div>
  </div>

  <div id="mainContent">
  <div class="card info-card">
    <div class="card-content">
      <span class="card-title">Netzwerkstatus</span>
      <p><strong>SSID:</strong> <span id="ssid">...</span></p>
      <p><strong>IP-Adresse:</strong> <span id="ip">...</span></p>
      <p><strong>mDNS:</strong> <span id="mdns">...</span></p>
    </div>
  </div>

  <div class="card info-card blue lighten-5">
    <div class="card-content">
      <span class="card-title blue-text">OTA</span>
      <p><strong>Status:</strong> <span id="otaEnabled">...</span></p>
      <p><strong>Host:</strong> <span id="otaHost">...</span></p>
      <p><strong>Port:</strong> <span id="otaPort">...</span></p>
      <p><strong>Fenster:</strong> <span id="otaWindow">...</span></p>
      <p><strong>Restzeit:</strong> <span id="otaRemaining">...</span></p>
      <p><strong>Passwort:</strong> <span id="otaPassword">••••••••</span></p>
    </div>
    <div class="card-action">
      <a class="btn blue" id="otaExtendBtn">
        <i class="material-icons left">timer</i> +10 Minuten
      </a>
      <a class="btn orange" id="otaRegenBtn">
        <i class="material-icons left">vpn_key</i> Passwort neu generieren
      </a>
    </div>
  </div>


  <div class="card red lighten-4">
    <div class="card-content">
      <span class="card-title red-text">Zurücksetzen</span>
      <p>Hier kannst du die gespeicherten WLAN-Zugangsdaten löschen. Danach startet der ESP32 im AP-Modus neu.</p>
    </div>
    <div class="card-action">
      <a class="btn btn-danger" id="resetBtn"><i class="material-icons left">delete</i> Zurücksetzen</a>
    </div>
  </div>
  
  <!-- Dynamic buttons injected from /admin/ui-config -->
  <div id="dynamicButtons" class="card" style="margin-top:1rem; padding:1rem;">
    <div class="card-content">
      <span class="card-title">Weitere Aktionen</span>
      <div id="dynamicButtonsContainer"></div>
    </div>
  </div>
  </div>

  <script src="/js/materialize.min.js"></script>
  <script>
    function showLogin() {
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
    }

    function showMain() {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    function fetchStatus() {
      return fetch('/status').then(r => {
        if (r.status === 401) {
          showLogin();
          throw new Error('unauthorized');
        }
        return r.json();
      });
    }

    fetchStatus()
      .then(data => {
        showMain();
        document.getElementById('ssid').textContent = data.ssid || '-';
        document.getElementById('ip').textContent = data.ip || '-';
        document.getElementById('mdns').textContent = data.mdns || '-';
      })
      .catch(err => {
        if (err.message !== 'unauthorized') console.error("Fehler beim Laden des Status:", err);
      });

    function loadOtaStatus() {
      fetch('/ota/status')
        .then(r => r.json())
        .then(data => {
          document.getElementById('otaEnabled').textContent = (data.enabled ? "aktiv" : "aus");
          document.getElementById('otaHost').textContent = data.host || '-';
          document.getElementById('otaPort').textContent = (data.port != null ? data.port : '-');
          document.getElementById('otaWindow').textContent = (data.windowSeconds != null ? (data.windowSeconds + " s") : '-');
          document.getElementById('otaRemaining').textContent = (data.remainingSeconds != null ? (data.remainingSeconds + " s") : '-');
          document.getElementById('otaPassword').textContent = (data.password && data.password.length ? data.password : "••••••••");
        })
        .catch(err => console.error("Fehler beim Laden des OTA-Status:", err));
    }

    loadOtaStatus();
    setInterval(loadOtaStatus, 5000);

    // login flow
    document.getElementById('loginBtn').onclick = () => {
      const pw = document.getElementById('adminPw').value;
      fetch('/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pw }) })
        .then(r => r.json())
        .then(res => {
          if (res.ok) {
            M.toast({ html: 'Login erfolgreich', classes: 'green' });
            // After successful login, reload status and OTA
            fetchStatus().then(data => {
              document.getElementById('ssid').textContent = data.ssid || '-';
              document.getElementById('ip').textContent = data.ip || '-';
              document.getElementById('mdns').textContent = data.mdns || '-';
              loadOtaStatus();
              showMain();
            }).catch(()=>{});
          } else {
            M.toast({ html: 'Login fehlgeschlagen', classes: 'red' });
          }
        })
        .catch(err => { M.toast({ html: 'Fehler', classes: 'red' }); console.error(err); });
    };

    document.getElementById('otaExtendBtn').onclick = () => {
      fetch('/ota/extend', { method: 'POST' })
        .then(r => {
          if (!r.ok) throw new Error("extend failed");
          M.toast({ html: "OTA-Window is refreshed", classes: "blue" });
          loadOtaStatus();
        })
        .catch(err => {
          M.toast({ html: "Error: OTA-Window is not refreshed", classes: "red" });
          console.error(err);
        });
    };

    document.getElementById('otaRegenBtn').onclick = () => {
      if (confirm("Generate new OTA-password?")) {
        fetch('/ota/regenerate-password', { method: 'POST' })
          .then(r => {
            if (!r.ok) throw new Error("regen failed");
            M.toast({ html: "Generated new password", classes: "orange" });
            loadOtaStatus();
          })
          .catch(err => {
            M.toast({ html: "Error: Cannot generate new password", classes: "red" });
            console.error(err);
          });
      }
    };

    document.getElementById('resetBtn').onclick = () => {
      if (confirm("Wirklich zurücksetzen und neu starten?")) {
        fetch('/reset', { method: 'POST' })
          .then(() => {
            M.toast({ html: "Zurückgesetzt. ESP32 startet neu...", classes: "red" });
          })
          .catch(err => {
            M.toast({ html: "Fehler beim Zurücksetzen", classes: "red" });
            console.error(err);
          });
      }
    };

    // load dynamic buttons from server-side UI config
    function loadDynamicButtons() {
      fetch('/admin/ui-config')
        .then(r => r.json())
        .then(cfg => {
          const container = document.getElementById('dynamicButtonsContainer');
          container.innerHTML = '';
          if (!cfg || !Array.isArray(cfg.buttons)) return;
          cfg.buttons.forEach(btn => {
            const a = document.createElement('a');
            a.className = 'btn';
            a.style.margin = '0.25rem';
            a.textContent = btn.label || btn.id || 'Action';
            a.onclick = () => {
              const doAction = () => {
                fetch(btn.path, { method: (btn.method||'GET') })
                  .then(r => {
                    if (!r.ok) throw new Error('request failed');
                    M.toast({ html: (btn.label || 'Action') + ' ausgeführt', classes: 'green' });
                  })
                  .catch(err => { M.toast({ html: 'Fehler', classes: 'red' }); console.error(err); });
              };
              if (btn.confirm) {
                if (confirm(btn.confirm === true ? 'Ausführen?' : btn.confirm)) doAction();
              } else {
                doAction();
              }
            };
            container.appendChild(a);
          });
        })
        .catch(err => { console.warn('No UI config', err); });
    }

    loadDynamicButtons();
  </script>
</body>

</html>